<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="evolify"><title>微信小程序request的Promise封装 · evblog</title><meta name="description" content="​    在我们开发过程中，经常需要附带一个token，所以这里把token单独抽取出来。
​    可能我们的接口都是以某一个特定的前缀开始的，比如 /api, 所以我们可以提取一个baseUrl，这样后面的请求中就可以不用每次都加上前缀了，而且后期修改也简单，只需要改一下配置文件就可以。
​  "><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/code_style_light.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.jpg" style="width:127px;"><h3 title=""><a href="/">evblog</a></h3><div class="description"><p>孤狼的博客</p></div></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/code">短码</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img></div></div></div><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>微信小程序request的Promise封装</a></h3></div><div class="post-content"><p>​    在我们开发过程中，经常需要附带一个token，所以这里把token单独抽取出来。</p>
<p>​    可能我们的接口都是以某一个特定的前缀开始的，比如 /api, 所以我们可以提取一个baseUrl，这样后面的请求中就可以不用每次都加上前缀了，而且后期修改也简单，只需要改一下配置文件就可以。</p>
<p>​    对于后台放回的数据，我们一般会用code来标记是否操作成功。这里可以做一个统一的错误处理，所以这里添加了一个拦截器数组，可以配置多个拦截器。</p>
<p>​    然后就是对方法的封装，首先写一个request方法来封装wx.request方法。然后再分别封装get、post、put、delete方法，使用的时候直接调用这几个方法就可以。</p>
<p>​    对于header、token、interceptor、baseUrl的配置方法，我们可以直接返回this实现链式调用。  </p>
<p>​    具体的在使用的时候，可以现在App.js的onLaunch方法中配置req。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> req <span class="keyword">from</span> <span class="string">'../../utils/Request.js'</span></span><br><span class="line"></span><br><span class="line">configReq()&#123;</span><br><span class="line">    <span class="comment">//配置baseUrl和拦截器，baseUrl例如 /api</span></span><br><span class="line">    req.baseUrl(config.serverUrl)</span><br><span class="line">      .interceptor(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(res.data.code)&#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">401</span>: </span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              icon: <span class="string">'loading'</span>,</span><br><span class="line">              title: <span class="string">'重新登录'</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">this</span>.login()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: <span class="string">'操作失败'</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>​    在登录后设置token<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.token(token)</span><br></pre></td></tr></table></figure></p>
<p>​    具体的网络请求方法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">req.post(<span class="string">'/goods'</span>,data,header)</span><br><span class="line">	.then(<span class="function"><span class="params">res</span>=&gt;</span>res.data.data)</span><br><span class="line">	.then(<span class="function"><span class="params">data</span>=&gt;</span>&#123;</span><br><span class="line">    	wx.showToast(&#123;</span><br><span class="line">            title:<span class="string">'创建成功'</span></span><br><span class="line">        &#125;)</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure></p>
<p>​    代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> METHOD=&#123;</span><br><span class="line">  GET:<span class="string">'GET'</span>,</span><br><span class="line">  POST:<span class="string">'POST'</span>,</span><br><span class="line">  PUT:<span class="string">'PUT'</span>,</span><br><span class="line">  DELETE:<span class="string">'DELETE'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line">  _header=&#123;</span><br><span class="line">    token:<span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  _baseUrl=<span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  interceptors = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">const</span> token=wx.getStorageSync(<span class="string">'token'</span>)</span><br><span class="line">    <span class="keyword">if</span>(token)&#123;</span><br><span class="line">      <span class="keyword">this</span>._header.token=token</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  intercept(res)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.interceptors</span><br><span class="line">                  .filter(<span class="function"><span class="params">f</span>=&gt;</span> <span class="keyword">typeof</span> f === <span class="string">'function'</span>)</span><br><span class="line">                  .every(<span class="function"><span class="params">f</span>=&gt;</span> f(res))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  request(&#123;url,method,header=&#123;&#125;,data&#125;)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: (<span class="keyword">this</span>._baseUrl || <span class="string">''</span>)+url,</span><br><span class="line">        method: method || METHOD.GET,</span><br><span class="line">        data: data,</span><br><span class="line">        header: &#123;</span><br><span class="line">          ...this._header,</span><br><span class="line">          ...header</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="params">res</span>=&gt;</span><span class="keyword">this</span>.intercept(res) &amp;&amp; resolve(res),</span><br><span class="line">        fail:reject</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get(url,data,header)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request(&#123;url,<span class="attr">method</span>:METHOD.GET,header,data&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  post(url,data,header)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request(&#123;url,<span class="attr">method</span>:METHOD.POST,header,data&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  put(url,data,header)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request(&#123;url,<span class="attr">method</span>:METHOD.PUT,header,data&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span>(url,data,header)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request(&#123;url,<span class="attr">method</span>:METHOD.DELETE,header,data&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  token(token)&#123;</span><br><span class="line">    <span class="keyword">this</span>._header.token=token</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">  header(header)&#123;</span><br><span class="line">    <span class="keyword">this</span>._header=header</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">  baseUrl(baseUrl)&#123;</span><br><span class="line">    <span class="keyword">this</span>._baseUrl=baseUrl</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">  interceptor(f)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> f === <span class="string">'function'</span>)&#123;</span><br><span class="line">      <span class="keyword">this</span>.interceptors.push(f)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Request</span><br><span class="line"><span class="keyword">export</span> &#123;METHOD&#125;</span><br></pre></td></tr></table></figure>
<h3 id="github-wxtools"><a href="#github-wxtools" class="headerlink" title="github: wxtools"></a>github: <a href="https://github.com/evolify/wxtools" target="_blank" rel="noopener">wxtools</a></h3></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-11-17</span><i class="fa fa-tag"></i><a href="/categories/article/" title="article" class="tag">article </a><a href="/tags/微信/" title="微信" class="tag">微信 </a><a href="/tags/小程序/" title="小程序" class="tag">小程序 </a><a href="/tags/request/" title="request" class="tag">request </a><a href="/tags/Promise/" title="Promise" class="tag">Promise </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://blog.evolify.cn/2017/11/17/微信小程序request的Promise封装/,evblog,微信小程序request的Promise封装,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/11/18/SpringMVC中使用注解清除拦截器/" title="SpringMVC中使用注解清除拦截器" class="btn">上一篇</a></li></ul></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/ev-nest.js"></script><script src="/js/ev-tag.js"></script></body></html>