<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="evolify"><title>简化React中的Action的写法，不要中间件，不写dispatch · evblog</title><meta name="description" content="&amp;emsp; 我们在写React应用时，通常用到redux做状态管理，然后会用到一些中间件来支持异步action，比如redux-thunk.通常我们的代码类似下面这样的：
123456789101112131415161718192021222324252627282930313233343536"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/code_style_light.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.jpg" style="width:127px;"><h3 title=""><a href="/">evblog</a></h3><div class="description"><p>孤狼的博客</p></div></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/code">短码</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img></div></div></div><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>简化React中的Action的写法，不要中间件，不写dispatch</a></h3></div><div class="post-content"><p>&emsp; 我们在写React应用时，通常用到redux做状态管理，然后会用到一些中间件来支持异步action，比如redux-thunk.通常我们的代码类似下面这样的：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActionType  R.js</span></span><br><span class="line"><span class="keyword">export</span> ActionType&#123;</span><br><span class="line">  	TYPE1:<span class="string">'type1'</span>,  </span><br><span class="line">  	TYPE2:<span class="string">'type2'</span>,  </span><br><span class="line">    TYPE3:<span class="string">'type3'</span>,  </span><br><span class="line">    <span class="comment">// others</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//reducer reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;ActionType <span class="keyword">as</span> AT&#125; <span class="keyword">from</span> <span class="string">'R'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">state=&#123;&#125;,action</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(action.type)&#123;</span><br><span class="line">    <span class="keyword">case</span> AT.TYPE1:</span><br><span class="line">      	<span class="keyword">return</span> &#123;</span><br><span class="line">          ...state,</span><br><span class="line">          ...action.data,</span><br><span class="line">          <span class="comment">// or other</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> AT.TYPE2:</span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    	<span class="keyword">return</span> state      </span><br><span class="line">  &#125;      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Action Action.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;ActionType <span class="keyword">as</span> AT&#125; <span class="keyword">from</span> <span class="string">'R'</span></span><br><span class="line"><span class="keyword">const</span> act = &#123;</span><br><span class="line">  action1:<span class="function"><span class="params">data</span>=&gt;</span><span class="function"><span class="params">dispatch</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// some action such as ajax</span></span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      type:AT.TYPE1,</span><br><span class="line">      data:&#123;</span><br><span class="line">        <span class="comment">// data</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;    </span><br><span class="line">  action2:<span class="function"><span class="params">()</span>=&gt;</span><span class="function">(<span class="params">dispatch,getState</span>)=&gt;</span>&#123;</span><br><span class="line">  	<span class="comment">// call another action</span></span><br><span class="line">  	dispatch(act.action3())</span><br><span class="line">  &#125;</span><br><span class="line">  action3:<span class="function"><span class="params">()</span>=&gt;</span><span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// even you never use the dispath or getState,you still have to code like this.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> act</span><br><span class="line"></span><br><span class="line"><span class="comment">// Component</span></span><br><span class="line">@connect(</span><br><span class="line">	state=&gt;state.reducer1,</span><br><span class="line">  	dispatch=&gt;bindActionCreators(Action,dispatch)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    doAction1()&#123;</span><br><span class="line">      <span class="keyword">this</span>.props.action1(&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render()&#123;</span><br><span class="line">      <span class="keyword">return</span>(</span><br><span class="line">      	&lt;div&gt;</span><br><span class="line">          anything <span class="keyword">else</span></span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>&emsp; 功能很简单，却需要些这么多actionType, reducer里面还有那么多case分支。而最烦的是action，直觉上我们是希望能够写普通的function,而不用强行写上dispatch和getState, 一个action调用另一个action竟然也不能直接调用。虽然我们知道是需要这样做，需要用actionType来区分action，reducer里面也需要根据type来做相应的更新，action中也需要dispatch来发出action。</p>
<p>&emsp; 但如果我们就是不想写的这么麻烦，能有什么办法吗？</p>
<p>&emsp; 答案之一是用mobx之类的工具来管理状态。当然，本文要介绍的是在redux中的方法，ev-redux. 先来看看使用后的效果：</p>
<p>&emsp; 首先安装:<code>npm i --save ev-redux</code> </p>
<p>&emsp; 然后你的代码差不多是这样：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init evStore in you app.js when create store.</span></span><br><span class="line"><span class="keyword">import</span> &#123;evStore&#125; <span class="keyword">from</span> <span class="string">'easy-redux'</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(...)</span><br><span class="line">evStore.init(store)</span><br><span class="line"></span><br><span class="line"><span class="comment">// redux/reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;ActionType <span class="keyword">as</span> TYPE&#125; <span class="keyword">from</span> <span class="string">'./index.js'</span></span><br><span class="line"><span class="keyword">const</span> initState=&#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">state=initState,action</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(action.type === TYPE)&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            ...state,</span><br><span class="line">            ...action.data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// redux/Action.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;evRedux&#125; <span class="keyword">from</span> <span class="string">'ev-redux'</span></span><br><span class="line"></span><br><span class="line">@evRedux</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(actionType)&#123;</span><br><span class="line">        <span class="keyword">this</span>.actionType = actionType</span><br><span class="line">    &#125;</span><br><span class="line">    action1(x)&#123;</span><br><span class="line">        <span class="keyword">this</span>.update(&#123;</span><br><span class="line">            x</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    action2()&#123;</span><br><span class="line">        <span class="keyword">this</span>.dispatch(&#123;</span><br><span class="line">            type:<span class="keyword">this</span>.actionType,</span><br><span class="line">            data:&#123;<span class="attr">y</span>:<span class="keyword">this</span>.getState().reducer2.y+<span class="number">1</span>&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      	<span class="comment">// to call another action, just call no need dispath!</span></span><br><span class="line">      	<span class="keyword">this</span>.action3(&#123;<span class="attr">z</span>:<span class="number">3</span>&#125;)</span><br><span class="line">        <span class="comment">// or just update</span></span><br><span class="line">        <span class="comment">// this.update(&#123;y:this.getState().reducer2.y+1&#125;)</span></span><br><span class="line">    &#125;</span><br><span class="line">    action3(z)&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.update(&#123;z&#125;)</span><br><span class="line">        &#125;,<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// redux/index.js</span></span><br><span class="line"><span class="keyword">import</span> Action <span class="keyword">from</span> <span class="string">'./Action'</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducer'</span></span><br><span class="line"><span class="keyword">import</span> &#123;connect <span class="keyword">as</span> conn&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> connect = <span class="function"><span class="params">view</span> =&gt;</span> conn(<span class="function"><span class="params">state</span>=&gt;</span>state.reducer2)(view)</span><br><span class="line"><span class="keyword">const</span> ActionType = <span class="built_in">Symbol</span>()</span><br><span class="line"><span class="keyword">const</span> action = <span class="keyword">new</span> Action(ActionType)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;reducer,ActionType,action,connect&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Component</span></span><br><span class="line"><span class="keyword">import</span> action <span class="keyword">from</span> <span class="string">'./action'</span></span><br><span class="line">@connect</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    doAction1()&#123;</span><br><span class="line">      <span class="comment">// just call an action as we call a function.</span></span><br><span class="line">      action.action1()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render()&#123;</span><br><span class="line">      <span class="keyword">return</span>(</span><br><span class="line">      	&lt;div&gt;</span><br><span class="line">          anything <span class="keyword">else</span></span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>&emsp; 不要只看着代码并没有减少。仔细看看 reducer和action部分，这样的action，这样的reducer你还不愿意用嘛？</p>
<ul>
<li>不需要中间件来支持异步任务。</li>
<li>不需要去写那么多actionTypes,一个reducer对应一个action就行，使用symbol保证不重复。</li>
<li>reducer中不需要那么多case分支，只需要合并一下action传过来的state和原来的state就可以。</li>
<li>重点是action，不需要手动在每个方法上加上dispatch和getState.你只需要在需要更新store时，构造好需要更新的那部分state,,然后调用update就行，type都不需要带。update哪儿来的？你直接用就行，后面会说。如果你想要用dispath和getState,直接从上下文取就行，this.dispatch,this.getState随便用。调用其他action,直接用this调用就ok，就像调用普通方法那样调用。</li>
</ul>
<p>ok了，用法介绍完了。具体的原理简单说明一下：</p>
<p>&emsp; 首先我们要触发reducer来更新store，就要用到dispatch来分发action。我们的update方法里面就是这么做的。之所以把构造要更新的state方法action, 而不是在reducer中通过不同的type来区分，是因为我觉得对于每个action，里需要更新那部分state，在action里面你是最清楚的。如果你在actino里面只是dispatch一个action，然后去reducer中构造state结构并更新，你不仅要写很多个多余的actionType，而且可能还要回头看这个type是哪个action触发的，还要回想这个action里面传过来的data是什么样的，明显比在action中构造要复杂。</p>
<p>&emsp; 至于为什么action中我们明明没写update，却可以直接用，其实在easy-redux中，我们对action做了代理。在初始或easyStore时，我们能够获取到dispatch和getState,然后在action的get方法中，我们用反射来set update、dispatch、getState. 这样在我们的action中就能够直接在上下文中调用到它们了。</p>
<p>&emsp; 原理就是用到js里面的代理和反射，代码也很简单，这里就不展开说明了，直接放上github地址：<a href="https://github.com/evolify/EvRedux" target="_blank" rel="noopener">https://github.com/evolify/EvRedux</a>  </p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-29</span><i class="fa fa-tag"></i><a href="/categories/article/" title="article" class="tag">article </a><a href="/tags/react/" title="react" class="tag">react </a><a href="/tags/redux/" title="redux" class="tag">redux </a><a href="/tags/evRedux/" title="evRedux" class="tag">evRedux </a><a href="/tags/ev-redux/" title="ev-redux" class="tag">ev-redux </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://blog.evolify.cn/2018/01/29/简化React中的Action的写法，不要中间件，不写dispatch/,evblog,简化React中的Action的写法，不要中间件，不写dispatch,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/03/15/code/hello-world/" title="hello world" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2018/01/12/react-redux中connect的装饰器用法@connect/" title="react-redux中connect的装饰器用法@connect" class="btn">下一篇</a></li></ul></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/ev-nest.js"></script><script src="/js/ev-tag.js"></script></body></html>